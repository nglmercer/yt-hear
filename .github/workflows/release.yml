name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (ej: 1.0.0)'
        required: true
        default: '1.0.0'
      draft:
        description: 'Crear como draft'
        required: true
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - platform: ubuntu-latest
            os: linux
            arch: x64
            ext: ''
          - platform: windows-latest
            os: windows
            arch: x64
            ext: .exe
          - platform: macos-latest
            os: darwin
            arch: x64
            ext: ''
        
    runs-on: ${{ matrix.platform }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install dependencies (ubuntu only)
      if: matrix.platform == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libglib2.0-dev pkg-config
        
    - name: Install dependencies (macOS only)
      if: matrix.platform == 'macos-latest'
      run: |
        # Install macOS dependencies for Tauri
        brew install python3
        
    - name: Rust setup
      uses: dtolnay/rust-toolchain@stable
      
    - name: Rust cache
      uses: swatinem/rust-cache@v2
      with:
        workspaces: './src-tauri -> target'
        
    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
        
    - name: Install frontend dependencies
      run: bun install
      
    - name: Build frontend
      run: bun run build
       
    - name: Build Tauri app
      shell: bash
      run: |
        # Determinar la versión
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION="${GITHUB_REF#refs/tags/v}"
        fi
        
        # Construir la aplicación
        bun run tauri build
        
        # Encontrar los artefactos construidos
        echo "Looking for artifacts in src-tauri/target/release/bundle"
        ls -la src-tauri/target/release/bundle/ || echo "Bundle directory not found"
        ls -la src-tauri/target/release/ || echo "Release directory not found"
        
        # Para Windows, buscar el ejecutable en release
        if [[ "${{ matrix.os }}" == "windows" ]]; then
          if [[ -f "src-tauri/target/release/yt-hear.exe" ]]; then
            mv src-tauri/target/release/yt-hear.exe src-tauri/target/release/yt-hear-${{ matrix.os }}-${{ matrix.arch }}-${VERSION}.exe
          elif [[ -f "src-tauri/target/release/yt-hear" ]]; then
            mv src-tauri/target/release/yt-hear src-tauri/target/release/yt-hear-${{ matrix.os }}-${{ matrix.arch }}-${VERSION}${{ matrix.ext }}
          fi
        else
          # Para Linux y macOS
          if [[ -f "src-tauri/target/release/yt-hear" ]]; then
            mv src-tauri/target/release/yt-hear src-tauri/target/release/yt-hear-${{ matrix.os }}-${{ matrix.arch }}-${VERSION}${{ matrix.ext }}
          fi
        fi
        
        # Listar archivos finales
        echo "Final artifacts:"
        ls -la src-tauri/target/release/yt-hear-* || echo "No artifacts found with expected pattern"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: yt-hear-${{ matrix.os }}-${{ matrix.arch }}
        path: |
          src-tauri/target/release/yt-hear-${{ matrix.os }}-${{ matrix.arch }}*
          src-tauri/target/release/bundle/
        retention-days: 30

  create-release:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
        
    - name: Determine version and release info
      id: release_info
      shell: bash
      run: |
        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          VERSION="${{ github.event.inputs.version }}"
          IS_DRAFT="${{ github.event.inputs.draft }}"
        else
          VERSION="${GITHUB_REF#refs/tags/v}"
          IS_DRAFT="false"
        fi
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
        
        # Crear notas del release
        if [[ -f "CHANGELOG.md" ]]; then
          # Extraer la sección del changelog para esta versión
          sed -n "/^## \[$VERSION\]/,/^## \[/p" CHANGELOG.md | sed '$d' > release_notes.md
        else
          echo "## Cambios en esta versión" > release_notes.md
          echo "- Corrección de errores y mejoras de rendimiento" >> release_notes.md
          echo "- Implementación de AdBlock funcional" >> release_notes.md
        fi
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        name: yt-hear ${{ steps.release_info.outputs.version }}
        tag_name: v${{ steps.release_info.outputs.version }}
        body_path: release_notes.md
        draft: ${{ steps.release_info.outputs.is_draft }}
        prerelease: false
        files: |
          artifacts/yt-hear-*-*/*
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
